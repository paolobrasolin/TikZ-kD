% tikzlibrarykD.core.code.tex
%
% Copyright 2015 by Paolo Brasolin <paolo.brasolin@gmail.com>
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.

% ######################################################################## SOF #

%\pgfkeys{
%  /kD/failsafe/.code={%
%    \let\searchname=\pgfkeyscurrentname%
%    \pgfkeys{
%      /tikz/\searchname/.try=#1,
%      /tikz/node contents/.retry/.expand once=\searchname,
%      }},
%}%.unknown/.style={/kD/failsafe=#1},

% ==================================================================== STYLING =

% Default settings
\pgfqkeys{/kD}{
  .search also=/tikz,
%  lattices/.search also=/tikz,
%  every lattice/.style={/kD/lattices/.cd},
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  current chain/.style={},
%  current chain/arrows/.style={},
%  current chain/labels/.style={},
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  objects/.search also=/tikz,
  arrows/.search also=/tikz,
  labels/.search also=/tikz,
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  every object/.style={
    self naming node,},
  every arrow/.style={},
  every label/.style={
    self naming node,
    auto,
    inner sep=+0.5ex,
    font=\everymath\expandafter{\the\everymath\scriptstyle},},
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  /kD/arrows/.cd,
    ->/.style={-Stealth},
  /kD/lattices/.cd,
    rect/.style 2 args={
      /tikz/column sep={#1,between origins},
      /tikz/row sep={#2,between origins},},
    comb/.style={
      rect={#1}{sqrt(3/4)*#1},
      /tikz/every even row/.style={xshift=-0.5*#1},},
    comb/.default=4em,
    mesh/.style={rect={#1}{#1}},
    mesh/.default=3em,
    gold/.style={rect={1.618*#1}{#1}},
    gold/.default=3em,
  /kD/arrows/.cd,
    l>/.style={bend right,->},
    r>/.style={bend left,->},
    crossing over/.style={preaction={-,
      draw=\pgfkeysvalueof{/kD/arrows/crossing over/color},
      line width=\pgfkeysvalueof{/kD/arrows/crossing over/clearance},},},
    crossing over/clearance/.initial=0.236em,
    crossing over/color/.initial=white,
    รท/.style={crossing over},
    รท>/.style={รท,->},
    shift/.style={transform canvas=
      {shift={($(\tikztostart)!#1!-90:(\tikztotarget)-(\tikztostart)$)}}},
    slide/.style={transform canvas=
      {shift={($(\tikztostart)!#1!0:(\tikztotarget)-(\tikztostart)$)}}},
  /kD/labels/.cd,
    mid/.style={inner sep=1.5pt,shape=circle,fill=white,anchor=center},
    </.style={near start},
    >/.style={near end},
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  /handlers/first char syntax=true,
  /handlers/first char syntax/the character "/.initial=\kDMathContentShortcut,
  /handlers/first char syntax/the character (/.initial=\kDNamingShortcut,
  /tikz/edge node list/.code args={[#1]#2}{
    \ifx\relax#1\relax\else\tikzset{edge node={node[/kD/.cd,every label,labels/.cd,#1]}}\fi
    \ifx\relax#2\relax\else\tikzset{edge node list={#2}}\fi
  },
  /tikz/node math contents/.style={/tikz/node contents={$#1$}}
}

\def\kDRemoveRoundParenthesis(#1){#1}
\def\kDRemoveDoubleQuotes"#1"{#1}
\def\kDNamingShortcut#1%
  {\pgfkeysalso{% a conditional is necessary: do alias iff name is empty
     /tikz/name/.expand once={\kDRemoveRoundParenthesis#1},
     /tikz/alias/.expand once={\kDRemoveRoundParenthesis#1},}}
\def\kDMathContentShortcut#1%
  {\pgfkeysalso{/tikz/node math contents/.expand once={\kDRemoveDoubleQuotes#1}}}

\pgfqkeys{/kD/parser}{
  object/.code={
    \pgfkeysalso{/kD/current object/.style={#1}}},
  morphism/.code={
    \kDBisect#1\at:\into SND\and FST\GO%
    \pgfkeysalso{/kD/current arrow/.style={}}
    \pgfkeysalso{/kD/parser/arrow={\SND}}
    \pgfkeysalso{/kD/parser/labels/.expand once={\FST}}},
  labels/.code={\def\doit##1##2\GO{\def\tmp{##1}}\def\sqr{[}\doit#1\GO%
    \ifx\tmp\sqr%
      \pgfkeysalso{/kD/current arrow/.append style={edge node list={#1}}}\else%
      \pgfkeysalso{/kD/current arrow/.append style={edge node list={[#1]}}}\fi},
  arrow/.code={
    \pgfkeysalso{/kD/current arrow/.append style/.expand once={#1}}},
}


% =========================================================== arrow keys: CHOP =

\def\kDChopParse#1|#2|#3\GO%
  {\kDBalancerInit\pgfdecoratedpathlength
   \kDBalancerTally#1\to One\GO
   \kDBalancerTally#2\to Two\GO
   \kDBalancerTally#3\to Thr\GO
   \expandafter\kDBalancerGauge\One\to Fst\GO
   \expandafter\kDBalancerGauge\Thr\to Lst\GO
   \pgfmathsetmacro\start{\Fst}
   \pgfmathsetmacro\stop{1-\Lst}}


\tikzset{/kD/arrows/chop/.style={ 
  decoration={ 
    show path construction, 
    curveto code={
      \kDFullExpandAfter\kDChopParse{#1}\GO
      \pgfpathcurvebetweentime{\start}{\stop}
      {\pgfpointdecoratedinputsegmentfirst}
      {\pgfpointdecoratedinputsegmentsupporta}
      {\pgfpointdecoratedinputsegmentsupportb}
      {\pgfpointdecoratedinputsegmentlast}},
    lineto code={
      \kDFullExpandAfter\kDChopParse{#1}\GO
      \pgfpathcurvebetweentime{\start}{\stop}
      {\pgfpointdecoratedinputsegmentfirst}
      {\pgfpointdecoratedinputsegmentfirst}
      {\pgfpointdecoratedinputsegmentlast}
      {\pgfpointdecoratedinputsegmentlast}}
  },decorate},
  % the following key has to be integrated into the syntax of the main key
  /kD/arrows/schop/.style={/kD/arrows/chop=#1|*|#1},
}

% ========================================================== PARAMETER PARSING =

\def\kDDoObject#1\GO%
  {\node [/kD/parser/object={#1},
          /kD/objects/.cd,
          /kD/every object,
          /kD/current object];}

\def\kDDoMorphism#1 #2 #3\GO%
  {\path (#1) edge [/kD/parser/morphism={#2},
                    /kD/arrows/.cd,
                    /kD/every arrow,
                    /kD/current arrow] (#3);}

%\let\kDThisSource\relax \let\kDLastSource\relax
%\let\kDThisTarget\relax \let\kDLastTarget\relax
%\def\kDLast{*}

\def\kDDoMorphismChain#1 #2 #3 #4\GO%
  {%\def\kDSource{#1}\ifx\kDSource\kDLast\let\kDSource\kDLastSource\fi
   %\def\kDTarget{#3}\ifx\kDTarget\kDLast\let\kDTarget\kDLastTarget\fi
   \kDDoMorphism{#1} {#2} {#3}\GO%
   %\ifx\kDThisSource\relax\let\kDThisSource\kDSource\fi
   \ifx\relax#4\relax% LAST CHAR BEFORE \GO MUST ME SPACE!
   %\let\kDLastSource\kDThisSource\let\kDThisSource\relax
   %\let\kDLastTarget\kDTarget
   \else\kDDoMorphismChain{#3} #4\GO%
   \fi}

% ============================================================= USER INTERFACE =

\def\obj#1;%
  {\kDDoObject#1\GO}

%\def\kDChainOptions{}

\def\MorChain #1;{%
%  \pgfkeys{/kD/current chain/arrows/.style={}}%
%  \pgfkeys{/kD/current chain/labels/.style={}}%
  \kDDoMorphismChain#1 \GO}
\def\MorOpt[#1] #2;{%
%  \kDBisect#1\at:\into ArrowSpec\and LabelSpec\GO%
%  \pgfkeys{/kD/current chain/arrows/.estyle=\ArrowSpec}%
%  \pgfkeys{/kD/current chain/labels/.estyle=\LabelSpec}%
  \kDDoMorphismChain#2 \GO}

\def\mor{\let\kDCommonOpt\relax\futurelet\MaybeSquare\MaybeOptMor}
\def\MaybeOptMor{\ifx[\MaybeSquare \let\next\MorOpt
\else \let\next\MorChain \fi \next}

%\def\lattice[#1]{\matrix[/kD/every lattice,#1]}

% ######################################################################## EOF #
